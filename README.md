# OAI repositories

### RAN

LTE & 5G Radio Access Network (RAN) repository: https://gitlab.eurecom.fr/oai/openairinterface5g

### Core Networks

5G Core Network (CN) repository: https://gitlab.eurecom.fr/oai/cn5g/oai-cn5g-fed

LTE Eovlved Packet Core (EPC) repository: https://github.com/OPENAIRINTERFACE/openair-epc-fed.

### Docker Images

Docker images: https://hub.docker.com/u/rdefosseoai

# Setup Schematic

![Setup Schematic](https://github.com/samiemostafavi/oai-lte-docker/blob/main/OAICN-Network-Deployment-Explanation.png "Setup Schematic")


# Step 1. Start LTE Evolved Packet Core (EPC)

Openairinterface LTE EPC consists of:
- HSS
- MME
- SPGW-U+SPGW-C

The federation repository is located at https://github.com/OPENAIRINTERFACE/openair-epc-fed.

There is 2 options regarding deployment of MME in Openairinterface:
- Magma MME [Start here](https://github.com/OPENAIRINTERFACE/openair-epc-fed/blob/master/docs/DEPLOY_HOME_MAGMA_MME.md)
- Legacy MME [Start here](https://github.com/OPENAIRINTERFACE/openair-epc-fed/blob/master/docs/DEPLOY_HOME.md) *

*Currently, OAI UE does not connect to Magma MME. Hence, in this tutorial we use `Legacy MME` which is not stable and could need restart after a few hours.

You can configure the EPC by modifiying the docker-compose file located at

    openair-epc-fed/docker-compose/oai-mme-legacy/docker-compose.yml

1. Init database

        cd openair-epc-fed/docker-compose/oai-mme-legacy/
        docker-compose up -d db_init
        docker logs prod-db-init --follow

2. After getting init *ok*, Deploy
        
        docker rm -f prod-db-init
        docker-compose up -d oai_spgwu

    Check if the containers are up or logs
    
        docker ps -a
        docker logs prod-oai-hss
        
    Check the deployed containers networks and ip of each service
    
        docker network ls
        docker network inspect prod-oai-public-net
    
3. Undeploy

        docker-compose down
    

# Step 2. Start LTE Base Station (eNB)

1. Pull enb docker image and clone this repository

        docker pull rdefosseoai/oai-enb:develop
        git clone git@github.com:samiemostafavi/oai-lte-docker.git
        cd ~/oai-lte-docker/enodeb
   
    Check whether the USRP device is connected on the docker host (if uhd drivers are installed)
   
        uhd_find_devices
        
    Check whether enb container connection to `MME` and `SPGW-C`
    
        docker-compose up check-enb-connections
        docker rm -f check-enb-connections

2. Modify the configuration file

    We use USRP B210 as the software-defined radio in this tutorial. There is a config file located at 

        https://gitlab.eurecom.fr/oai/openairinterface5g/-/blob/develop/ci-scripts/conf_files/enb.band7.tm1.fr1.25PRB.usrpb210.conf
    
    which is copied to `enodeb/enb.conf` and you must modify it as the steps below

    - Modify `plmn_list` which consists of MCC, MNC, and TAC (`tracking_area_code`) so it matches MME configuration.
    - Modify `CI_MME_IP_ADDR` of `mme_ip_address.ipv4` so it matches MME configuration. 
    - Modify `CI_ENB_IP_ADDR` of `NETWORK_INTERFACES` section and set an arbitrary ip address for enb server in the `prod-oai-public-net` subnet. NOTE: if you are runing enb on the same machine, `ENB_INTERFACE_NAME_FOR_*` is not important. Otherwise, set it properly.

3. Deploy and check the logs

        docker-compose up -d prod-oai-enb
        docker logs prod-oai-enb --follow
   
    Undeploy
    
        docker-compose down


# Step 3. Start LTE UE

1. Pull enb docker image and clone this repository

        docker pull rdefosseoai/oai-lte-ue:develop
        git clone git@github.com:samiemostafavi/oai-lte-docker.git
        cd ~/oai-lte-docker/lte-ue
        
    Check whether the USRP device is connected on the docker host (if uhd drivers are installed)
   
        uhd_find_devices
        
2. Modify the configuration file

    Openairinterface UE needs to read sim information from `.usim` and `.nvram` files. They are generated by certain scripts in the docker container from `ue.conf` file.
    
    There is a config file located at 

        https://gitlab.eurecom.fr/oai/openairinterface5g/-/blob/develop/openair3/NAS/TOOLS/ue_sim_ci.conf
    
    which is copied to `lte-ue/ue_usim.conf` and you must modify it as the steps below    

    - Modify `PLMN` section and set the `MNC` and `MCC` values according to MME and eNB configuration.
    - In the `UE` section, set HPLMN which is *Home PLMN* as the concatination of `MCC`+`MNC` e.g. `MCC=222`,`MNC=01`, `PLMN=22201`. You must add `PLMN` code to the *Operator PLMN List* or `OPLMN_LIST` as well.
    - `MSIN` or mobile subscription identification number is a 9 or 10 digit number within the network's customer base. Check HSS configuration and look for the `FIRST_IMSI` parameter. As explained below, you can find the first `MSIN` that you should pick for the UEs. Also check `NB_USERS` in HSS configurations. That would be the maximum number of UEs that are allowed into the LTE network. The UE `MSIN`s must be in this format: `UE#i MSIN = FIRST_MSIN + i (i=0,1,2,...)`.
    - `IMSI` is a number that uniquely identifies every user of a cellular network. The first 3 digits represent `MCC`, which is followed by the `MNC`, either 2-digit (European standard) or 3-digit (North American standard). The remaining 9 or 10 digits are `MSIN`. The `IMSI` is stored in the SIM (the card inserted into the mobile phone), and uniquely identifies the mobile station, its home wireless network, and the home country of the home wireless network.
    - `USIM_API_K` must be set equal to `LTE_K` parameter is HSS server configuration.
    - `OPC` should be generated from `LTE_K`, `OP_KEY`, and `RijndaelKeySchedule K`. The last one is not defined as a parameter in any config file of OAI. Probably it is hardcoded somewhere: `0C0A34601D4F07677303652C0462535B`. `LTE_K` and `OP_KEY` are defined in HSS configuration. In order to set `OPC` there are 2 ways:
        1.   Generate it using [kiopcgenerator](https://github.com/PodgroupConnectivity/kiopcgenerator). Install the tool and run it as below
        
                    kiopcgen -o [OP_KEY] -t [LTE_K] -k [RijndaelKeySchedule K]
            
                For example:
            
                    kiopcgen -o 63bfa50ee6523365ff14c1f45f88737d -t 0c0a34601d4f07677303652c0462535b -k 0C0A34601D4F07677303652C0462535B
                    {'KI': '0C0A34601D4F07677303652C0462535B',
                    'OPC': b'BA05688178E398BEDC100674071002CB',
                    'eKI': '4F3C9E8F870E54A0F287D18030A47329'}
                
                set 'OPC' to the output of the `kiopcgen` with the name 'OPC'.
            
        2.   Look through HSS logs and check the keys generated for `NB_USERS` number of UEs. You can find what is `RijndaelKeySchedule K` from the logs as well.

                    docker logs prod-oai-hss
                    [2021-12-06T13:10:01.714] [hss] [system] [info] COUNT: 1 IMSI: 208960010000001 KEY: 0c0a34601d4f07677303652c0462535b OPC: 8e27b6af0e692e750f32667a3b14605d NEW OPC: ba05688178e398bedc100674071002cb
                    RijndaelKeySchedule: K 0C0A34601D4F07677303652C0462535B
                    Compute opc:
                    K:	0C0A34601D4F07677303652C0462535B
                    In:	63BFA50EE6523365FF14C1F45F88737D
                    Rinj:	D9BACD8F9EB1ABDB2304C780589871B6
                    Out:	BA05688178E398BEDC100674071002CB
                
                set 'OPC' to the output of the `Compute opc` with the name 'Out'.
        
    - `MSISDN` is a number uniquely identifying a subscription in GSM or UMTS. It is the mapping of the telephone number to the subscriber identity module in a mobile or cellular phone. The `IMSI` is stored in the SIM (the card inserted into the mobile phone), and uniquely identifies the mobile station, its home wireless network, and the home country of the home wireless network. The `MSISDN` is used for routing calls to the subscriber. The `IMSI` is often used as a key in the home location register ("subscriber database") and the `MSISDN` is the number normally dialed to connect a call to the mobile phone. A SIM has a unique `IMSI` that does not change, while the `MSISDN` can change in time, i.e. different `MSISDN`s can be associated with the SIM. You can leave this parameter to the default value.

    For furthur information, read more at:

        https://gitlab.eurecom.fr/oai/openairinterface5g/-/wikis/how-to-run-oaisim-with-multiple-ue
        https://gitlab.eurecom.fr/oai/openairinterface5g/-/blob/develop/doc/BASIC_SIM.md
        https://gitlab.eurecom.fr/oai/openairinterface5g/-/wikis/l2-nfapi-simulator/l2-nfapi-simulator-w-S1-same-machine#3-retrieve-the-oai-enb-ue-source-code
        https://github.com/danielgora/openair-epc-fed/blob/develop/docs/EPC_IN_A_BOX.md

3. Deploy and check the logs

        docker-compose up -d prod-oai-lte-ue
        docker logs prod-oai-lte-ue --follow
   
    Undeploy
    
        docker-compose down 
    
    NOTE: According to Raphael in an answer to mailing list with the subject `UE-softmodem fails to add ip address`, `nasmesh` is not much more worked on at Eurecom. So use `--nokrnmod 1` all the time for OAI UE.
    

